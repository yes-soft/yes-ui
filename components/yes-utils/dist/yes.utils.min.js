"use strict";angular.module("yes.utils",["yes.auth","yes.settings","oc.lazyLoad"]),angular.module("yes.utils").provider("utils",["settingsProvider",function(e){var t=this,n={};t.settings=e.getSettings(),t.getSettings=e.getSettings,t.setSettings=e.setSettings,n.settings=t.settings,t.getService=function(e){var t=angular.element("body").injector();return t.has(e)?t.get(e):{}},t.addModule=function(e,t){n[e]=t},this.$get=function(){return n}}]),angular.module("yes.utils").config(["utilsProvider",function(e){var t=e.settings,n=function(e){var n=e.split("/");return t.mock&&n.length?"data/"+n.slice(3).join(".")+".json":e},r=function(){return function(e){if(0===e.indexOf("http"))return e;0!==e.indexOf(t.apiPath)&&(e=[t.apiPath,e].join("/").replace(/\/\//g,"/"));var n="self"!==t.host?t.host:location.protocol+"//"+location.host;return e=[n,e].join("/")}}(),i=function(i,o,a,u){var l=e.getService("$http"),s=e.getService("$q"),c=r(o);c=n(c);var f={method:i,url:c,cache:!1,headers:u||t.headers};a&&angular.forEach(a,function(e,t){""==e&&delete a[t]}),!a||"post"!=i.toLowerCase()&&"put"!=i.toLowerCase()||angular.isString(f.headers)&&!(f.headers["Content-Type"].indexOf("json")>0)?a&&(f.data=this.serialize(a)):f.data=a;var d=s.defer();return c?(f.data&&"get"==f.method.toLowerCase()&&(f.url=f.url+"?"+f.data),l(f).success(function(e){0!=e.error&&e.error?d.reject(e.message?e:{message:"服务器异常"}):d.resolve(e)}).error(function(e){d.reject({message:"无法连接到服务器"})}),d.promise):void d.reject({message:"Uri is empty!"})};e.addModule("async",i)}]),angular.module("yes.auth",[]).factory("authInterceptor",["$q","$location",function(e,t){var n=!0;return{request:function(e){return e},response:function(t){return t||e.when(t)},responseError:function(r){return 401===r.status&&n&&(n=!1,t.path("/login").search("return",encodeURIComponent(location.hash)),setTimeout(function(){n=!0},12e3)),e.reject(r)}}}]).config(["$httpProvider",function(e){e.defaults.withCredentials=!0,e.interceptors.push("authInterceptor")}]),angular.module("yes.utils").config(["utilsProvider",function(e){var t=e.settings,n="self"!==t.host?t.host:location.protocol+"//"+location.host,r=n+location.pathname.substr(0,location.pathname.lastIndexOf("/")),i=function(){return angular.element("body").injector()},o=function(e,t){angular.isFunction(e)?i().invoke(e,t):angular.isArray(e)&&angular.forEach(e,function(e){o(e,t)})},a={format:function(e){var t=Array.prototype.slice.call(arguments,1);return e?e.replace(/{(\d+)}/g,function(e,n){return"undefined"!=typeof t[n]?t[n]:e}):""},capitalize:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},currentPage:function(){var e=$location.search()[e];return parseInt(e)||1},disableScroll:function(){document.body.style.overflow="hidden",angular.element(window).trigger("resize")},resetScroll:function(){document.body.style.overflow=null,angular.element(window).trigger("resize")},dialogUpload:function(e){console.log(e)},array2Object:function(e,t){for(var n={},r=0;r<e.length;++r)e[r].hasOwnProperty(t)?n[e[r][t]]=e[r]:n[r]=e[r];return n},invoke:o};for(var u in a)a.hasOwnProperty(u)&&e.addModule(u,a[u]);e.addModule("host",n),e.addModule("root",r)}]),angular.module("yes.utils").config(["utilsProvider",function(e){var t=function(){var e={};return{on:function(t,n){return t.split(" ").forEach(function(t){e[t]||(e[t]=[]),e[t].push(n)}),this},once:function(t,n){return t.split(" ").forEach(function(t){e[t]=[],e[t].push(n)}),this},trigger:function(t,n){return angular.forEach(e[t],function(e){e.call(null,n)}),this}}},n=new t;e.addModule("createEvents",function(){return new t}),e.addModule("events",n)}]),angular.module("yes.utils").config(["utilsProvider",function(e){function t(e,t){return e&&e.toLowerCase()===t.toLowerCase()}function n(e,n){return e="number"==typeof e?e:0,n=n||{},n.fixed="number"==typeof n.fixed?n.fixed:2,n.spacer="string"==typeof n.spacer?n.spacer:" ",n.calculate=function(r){var i,o=t(r,"si")?["k","B"]:["K","iB"],a=t(r,"si")?1e3:1024,u=Math.log(e)/Math.log(a)|0,l=e/Math.pow(a,u),s=l.toFixed(n.fixed);return 3>u-1&&!t(r,"si")&&t(r,"jedec")&&(o[1]="B"),i=u?(o[0]+"MGTPEZY")[u-1]+o[1]:1===(0|s)?"Byte":"Bytes",{suffix:i,magnitude:u,result:l,fixed:s,bits:{result:l/8,fixed:(l/8).toFixed(n.fixed)}}},n.to=function(n,r){var o=t(r,"si")?1e3:1024,a=i.indexOf("string"==typeof n?n[0].toUpperCase():"B"),u=e;if(-1===a||0===a)return u.toFixed(2);for(;a>0;a--)u/=o;return u.toFixed(2)},n.human=function(e){var t=n.calculate(e);return t.fixed+n.spacer+t.suffix},n}function r(e){var t=/(?:\.([^.]+))?$/,n=t.exec(e)[1];return o.hasOwnProperty(n)?o[n]:o.defaults}var i="BKMGTPEZY".split(""),o={defaults:"ico ico-file ico-file-1",xls:"ico ico-file ico-file-2",xlsx:"ico ico-file ico-file-2",doc:"ico ico-file ico-file-3",docx:"ico ico-file ico-file-3",ppt:"ico ico-file ico-file-4",pptx:"ico ico-file ico-file-4",rar:"ico ico-file ico-file-6",zip:"ico ico-file ico-file-7",html:"ico ico-file ico-file-10",js:"ico ico-file ico-file-11",xml:"ico ico-file ico-file-12",css:"ico ico-file ico-file-12",pdf:"ico ico-file ico-file-17",txt:"ico ico-file ico-file-22",jpg:"ico ico-file ico-file-31",gif:"ico ico-file ico-file-32",png:"ico ico-file ico-file-33",bmp:"ico ico-file ico-file-34"};e.addModule("getFileSize",n),e.addModule("getFileExtCss",r)}]),angular.module("yes.utils").factory("interpreter",["$stateParams","oPath","utils",function(e,t,n){var r=n.settings,i=function(e,t){for(var n={},r=0;r<e.length;++r)e[r].hasOwnProperty(t)?n[e[r][t]]=e[r]:n[r]=e[r];return n},o=angular.element("body").injector(),a=function(e,t){var n=e+".config";if(o.has(n)){var r=o.get(n);if(r.hasOwnProperty(t))return r[t]}return null},u=function(e,t){angular.isFunction(e)?(console.log(e.constructor.toString()),o.invoke(e,t)):angular.isArray(e)&&angular.forEach(e,function(e){u(e,t)})},l=function(e,n){var r=t.get(e,"operation",[]);if(!r)return e;var i=[],a={add:{name:"新建",action:n.action.create},del:{name:"删除",action:n.action.del}},u={scope:n};return angular.forEach(r,function(e,t){if(e){var n=a[t]||{name:e.name,action:e.action};angular.isFunction(e.action)&&(n.action=function(){o.invoke(e.action,u)}),i.push(n)}}),e.operations=i,e},s=function(e,n){var r={scope:n,list:e.list},i=t.get(e,"list.resolves",[]);return console.log("test 111 ",r),u(i,r),e},c=function(e,t,n){e&&(e[t]=e[t]||angular.copy(n))},f=function(e,t){if(!e)throw"can not override properties with null";for(var n in t)t.hasOwnProperty(n)&&c(e,n,t[n])},d=function(e,n){var r=t.get(e,"schema.properties",{});angular.isArray(r)&&(e.schema.properties=i(r,"key"));var o={scope:n,form:e.form};angular.isArray(e.form)&&angular.forEach(e.form,function(t){angular.forEach(t.items,function(t){("datepicker"==t.type||"datetimepicker"==t.type)&&(t.title=t.title||e.schema.properties[t.key].title,t.open=function(e){e.preventDefault(),e.stopPropagation(),t.opened=!0}),angular.isObject(t)&&(t.required=t.required||e.schema.properties[t.key].required)})});var a=t.get(e,"resolves",[]);return u(a,o),e},g=function(t){if(!angular.isUndefined(t)){if(0==t.indexOf("http")||t.indexOf("plugins")>-1)return t;var i=[r.pluginFolder,e.name,"templates",t].join("/").replace(/\/\//g,"/");return[n.root,i].join("/")}},p=function(){var t=a(e.name,"_default")||{};return t=angular.extend({list:{},form:{}},t),c(t.form,"template",[n.root,r.templates.detail].join("/")),c(t.list,"template",[n.root,r.templates.list].join("/")),c(t.list,"pageSize",r.pageSize["default"]),t};return{configuration:function(t){var n=p(),r=a(e.name,e.page)||{};return c(r,"form",{}),c(r,"list",{}),f(r.form,n.form),f(r.list,n.list),r.list.template=g(r.list.template),r.form.template=g(r.form.template),r=l(r,t),r=s(r,t),r.form=d(r.form,t),r}}}]),angular.module("yes.utils").config(["utilsProvider",function(e){var t={},n=e.settings,r=function(e,t,n){if(angular.isUndefined(e))return[];e.parents=e.parents||[];var i=n.filter(function(e){return e.uid==t.parent});0==e.parents.length&&e.parents.push(e.label),i.length&&(e.parents.push(i[0].name),r(e,i[0],n))},i=function(e){(angular.isUndefined(e.url)||"#"==e.url)&&(e.url=""),0===e.url.indexOf("/")&&angular.isDefined(n.serverRoot)&&(e.url=n.serverRoot+e.url)},o=function(e){var n={};angular.forEach(e,function(e){n[e.uid]=e,i(e),angular.isString(e.uid)&&e.parent&&e.type&&"menu"==e.type.toLowerCase()&&(t[e.parent]=t[e.parent]||[],t[e.parent].push(e))}),angular.forEach(e,function(e){e.parentNode=n[e.parent]})},a=function(e,n){return o(n),n.filter(function(n){return n.subMenus=t[n.uid],n.parent==e})},u={initMenus:a,buildMenuTree:function(e){var t=[];return angular.forEach(e,function(n){var i={label:n.name,url:n.url,parent:n.parent,uid:n.uid};r(i,i,e),i.name=i.parents.reverse().join(" > "),t.push(i)}),t}};e.addModule("menus",u)}]),angular.module("yes.utils").factory("oPath",[function(){var e;return e=function(){function e(e){if(!e)return!0;if(f(e)&&0===e.length)return!0;if(!s(e)){for(var t in e)if(u.call(e,t))return!1;return!0}return!1}function t(e){return a.call(e)}function n(e){return"boolean"==typeof e||"[object Boolean]"===t(e)}function r(e){var t=parseInt(e);return t.toString()===e?t:e}function i(t,n,o,a){if(l(n)&&(n=[n]),e(n))return t;if(s(n))return i(t,n.split(".").map(r),o,a);var u=n[0];if(1===n.length){var c=t[u];return void 0!==c&&a||(t[u]=o),c}return void 0===t[u]&&(t[u]=l(n[1])?[]:{}),i(t[u],n.slice(1),o,a)}function o(t,n){if(l(n)&&(n=[n]),e(t))return void 0;if(e(n))return t;if(s(n))return o(t,n.split("."));var i=r(n[0]),a=t[i];if(1===n.length)void 0!==a&&(f(t)?t.splice(i,1):delete t[i]);else if(void 0!==t[i])return o(t[i],n.slice(1));return t}var a=Object.prototype.toString,u=Object.prototype.hasOwnProperty,l=angular.isNumber,s=angular.isString,c=angular.isObject,f=angular.isArray,d=function(e){return Object.keys(d).reduce(function(t,n){return"function"==typeof d[n]&&(t[n]=d[n].bind(d,e)),t},{})};return d.has=function(t,n){if(e(t))return!1;if(l(n)?n=[n]:s(n)&&(n=n.split(".")),e(n)||0===n.length)return!1;for(var r=0;r<n.length;r++){var i=n[r];if(!c(t)&&!f(t)||!u.call(t,i))return!1;t=t[i]}return!0},d.ensureExists=function(e,t,n){return i(e,t,n,!0)},d.set=function(e,t,n,r){return i(e,t,n,r)},d.insert=function(e,t,n,r){var i=d.get(e,t);r=~~r,f(i)||(i=[],d.set(e,t,i)),i.splice(r,0,n)},d.empty=function(t,r){if(e(r))return t;if(e(t))return void 0;var i,o;if(!(i=d.get(t,r)))return t;if(s(i))return d.set(t,r,"");if(n(i))return d.set(t,r,!1);if(l(i))return d.set(t,r,0);if(f(i))i.length=0;else{if(!c(i))return d.set(t,r,null);for(o in i)u.call(i,o)&&delete i[o]}},d.push=function(e,t){var n=d.get(e,t);f(n)||(n=[],d.set(e,t,n)),n.push.apply(n,Array.prototype.slice.call(arguments,2))},d.coalesce=function(e,t,n){for(var r,i=0,o=t.length;o>i;i++)if(void 0!==(r=d.get(e,t[i])))return r;return n},d.find=function(t,n,i){if(l(n)&&(n=[n]),e(n))return t;if(e(t))return i;s(n)&&d.find(t,n.split("."),i);var o=r(n[0]);if(/\[(.*?)\]/g.test(o)&&f(t))for(var a=/\[(.*?)\]/g.exec(o)[1],u=a.split(":"),c=0;c<t.length;c++)if(t[c].hasOwnProperty(u[0])&&t[c][u[0]]==u[1])return d.find(t[c],n.slice(1),i);return 1===n.length?void 0===t[o]?i:t[o]:d.find(t[o],n.slice(1),i)},d.get=function(t,n,i){if(l(n)&&(n=[n]),e(n))return t;if(e(t))return i;if(s(n))return d.get(t,n.split("."),i);var o=r(n[0]);return 1===n.length?void 0===t[o]?i:t[o]:d.get(t[o],n.slice(1),i)},d.del=function(e,t){return o(e,t)},d}()}]),angular.module("yes.utils").config(["utilsProvider",function(e){var t=function(e){if(!angular.isObject(e))return null==e?"":e.toString();var t=[];for(var n in e)if(e.hasOwnProperty(n)){var r=e[n];angular.isDate(r)&&moment&&(r=moment(r).format("YYYY-MM-DD HH:mm:ss")),t.push(encodeURIComponent(n)+"="+encodeURIComponent(null==r?"":r))}var i=t.join("&");return i};e.addModule("serialize",t)}]),angular.module("yes.settings",[]).provider("settings",[function(){var e=this;e.settings={version:"0.0.0",language:navigator.language||navigator.userLanguage,templates:{layout:"base/templates/layout.html",login:"base/templates/login.html",dashboard:"base/templates/dashboard.html",list:"base/templates/list.uigrid.html",detail:"base/templates/detail.html",searchCommon:"base/templates/search-common.html"},host:"self",mock:!0,debug:!0,pageSize:{defaults:20,more:10},headers:{"Content-Type":"application/json"},menuRoot:null,menuApi:"base/menus",apiPath:"api",serverRoot:"src",pluginFolder:"plugins"},e.setSettings=function(t){e.settings=t},e.getSettings=function(){return e.settings},this.$get=function(){return e.settings}}]);